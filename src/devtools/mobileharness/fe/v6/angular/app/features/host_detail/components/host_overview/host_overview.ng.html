<app-master-detail-layout [navList]="navList">
  <app-info-card #overviewSection id="overview" title="Overview" [collapsible]="false">
    <div class="info-card-content">
      <div class="grid-wrapper">
        <dl class="grid-tight">
          <dt title="HostName">Host Name</dt>
          <dd title="{{ host.hostName }}" class="overflow-ellipsis">{{ host.hostName || 'N/A' }}</dd>

          <dt title="HostIP">Host IP</dt>
          <dd title="{{ host.ip }}" class="overflow-ellipsis">{{ host.ip || 'N/A' }}</dd>

          <dt title="OS">OS</dt>
          <dd title="{{ host.os }}" class="overflow-ellipsis">{{ host.os || 'N/A' }}</dd>

          <dt title="LabType">Lab Type</dt>
          <dd class="lab-type-wrapper">
            @if (host.labTypeDisplayNames.length > 0) {
              @for (labType of host.labTypeDisplayNames; track labType) {
                <div class="lab-type-chip overflow-ellipsis" title="{{ labType }}">
                  {{ labType }}
                </div>
              }
            } @else {
              <div class="lab-type-chip overflow-ellipsis" title="N/A">
                N/A
              </div>
            }
          </dd>
        </dl>
      </div>
    </div>
  </app-info-card>
  <app-info-card #overviewSection id="lab-server" title="Lab Server" [collapsible]="false">
    <div operations class="operation-button">
      <a href="#" target="_blank">
        <mat-icon>article</mat-icon>
        <span class="operation-text">View Log</span>
        <mat-icon>open_in_new</mat-icon>
      </a>
    </div>
    <div class="info-card-content">
      <dl class="grid-tight">
        <dt>State</dt>
        @let connectivitySemantic = getStatusSemantic(host.labServer.connectivity);
        <dd
          class="grid-tight-dd {{ connectivitySemantic.colorClass }}"
          title="{{ connectivitySemantic.tooltip }}"
        >
          <mat-icon matTooltip="{{ connectivitySemantic.tooltip }}">{{ connectivitySemantic.icon }}</mat-icon>
          <span matTooltip="{{ connectivitySemantic.tooltip }}"
            >{{ connectivitySemantic.text }}
            {{ connectivitySemantic.duration ? '(' + connectivitySemantic.duration + ')' : ''
            }}</span
          >
          <mat-icon matTooltip="{{ connectivitySemantic.tooltip }}" class="cursor-help">help_outline</mat-icon>
        </dd>

        @if (host.labServer.activity; as activity) {
          @let activitySemantic = getLabActivitySemantic(activity);
          <dt>Activity</dt>
          <dd
            class="grid-tight-dd {{ activitySemantic.colorClass }}"
            title="{{ activitySemantic.tooltip }}"
          >
            <mat-icon matTooltip="{{ activitySemantic.tooltip }}" [class.spin-animation]="activitySemantic.isSpinning">{{
              activitySemantic.icon
            }}</mat-icon>
            <span matTooltip="{{ activitySemantic.tooltip }}">{{ activitySemantic.text }}</span>
            <mat-icon matTooltip="{{ activitySemantic.tooltip }}" class="cursor-help">help_outline</mat-icon>
          </dd>
        }

        <dt>Version</dt>
        <dd>{{ host.labServer.version }}</dd>

        <dt>Pass Through Flags
          <mat-icon
            class="cursor-help"
            matTooltip="Flags passed directly to the lab server instance on startup for custom configuration."
            >help_outline</mat-icon
          >
        </dt>
        <dd [class.grid-tight-dd]="!isEditingFlags()">
          @if(isEditingFlags()) {
            <div class="flags-edit-container">
              <textarea
                [(ngModel)]="editedFlags"
                class="flags-textarea"
                rows="5"
                placeholder="Enter flags..."
              ></textarea>
              <div class="flags-edit-actions">
                <button (click)="cancelEditFlags()" class="flags-edit-button cancel" [disabled]="isSavingFlags()">Cancel</button>
                <button (click)="saveFlags()" class="flags-edit-button save" [disabled]="isSavingFlags()">
                  @if (isSavingFlags()) {
                    <mat-progress-spinner mode="indeterminate" diameter="16" class="button-spinner"></mat-progress-spinner>
                    Saving...
                  } @else {
                    Save
                  }
                </button>
              </div>
            </div>
          } @else {
            @if (host.labServer.passThroughFlags) {
              <div class="monospace-block">{{ host.labServer.passThroughFlags }}</div>
            } @else {
              <span class="text-gray-500">None</span>
            }
            <button
              mat-icon-button
              (click)="startEditFlags()"
              title="Edit Pass Through Flags"
              class="edit-flags-button"
            >
              <mat-icon>edit</mat-icon>
            </button>
          }
        </dd>
      </dl>
    </div>
  </app-info-card>
  <app-info-card #overviewSection id="device-list" title="Devices" [collapsible]="false">
    @if(isDeviceLoading()) {
      <mat-progress-bar mode="indeterminate" class="device-loading-bar"></mat-progress-bar>
    } @else if(deviceDataSource.data.length > 0) {
      <div class="info-card-content">
          <div class="device-table-toolbar">
            @if(selection.isEmpty()) {
              <div class="device-toolbar-content">
                <h4 class="device-toolbar-header">
                  Total Devices <span class="device-count">({{ deviceDataSource.data.length }})</span>
                </h4>
                <mat-form-field appearance="outline" class="device-filter-input" subscriptSizing="dynamic">
                  <mat-icon matPrefix>search</mat-icon>
                  <input matInput [(ngModel)]="deviceFilterInput" (ngModelChange)="applyDeviceFilter()" placeholder="Filter devices..." #input aria-label="Filter devices"/>
                  <button matSuffix mat-icon-button
                          aria-label="Clear filter"
                          (click)="clearDeviceFilter()"
                          [style.visibility]="deviceFilterInput ? 'visible' : 'hidden'">
                    <mat-icon>close</mat-icon>
                  </button>
                </mat-form-field>
              </div>
            } @else {
              <div class="device-toolbar-content selected">
                <button mat-icon-button (click)="selection.clear()" aria-label="Clear selection" class="clear-selection-button">
                  <mat-icon>close</mat-icon>
                </button>

                @if (deviceFilterValue) {
                  <span class="selected-text">{{selection.selected.length}} of {{deviceDataSource.filteredData.length}} filtered results selected (total: {{deviceDataSource.data.length}})</span>
                } @else {
                  <span class="selected-text">{{selection.selected.length}} of {{deviceDataSource.data.length}} selected</span>
                }

                <div class="separator"></div>

                <button mat-flat-button class="action-button" matTooltip="Configure">
                  <mat-icon>settings</mat-icon>
                  <span class="action-button-text">Configure</span>
                </button>
                <button mat-flat-button class="action-button" matTooltip="Remote Control" (click)="startMultiRemoteControl()">
                  <mat-icon>important_devices</mat-icon>
                  <span class="action-button-text">Remote Control</span>
                </button>
                @if(decommissionMissingCount() > 0) {
                  <button mat-flat-button class="action-button" [matTooltip]="'Decommission Missing (' + decommissionMissingCount() + ')'" (click)="decommissionMissing()">
                    <mat-icon>delete_sweep</mat-icon>
                    <span class="action-button-text">Decommission Missing ({{decommissionMissingCount()}})</span>
                  </button>
                }
              </div>
            }
          </div>
          <div class="device-table-container scroll-container">
            <table mat-table [dataSource]="deviceDataSource" multiTemplateDataRows>
              <!-- Checkbox Column -->
              <ng-container matColumnDef="select" sticky>
                <th mat-header-cell *matHeaderCellDef class="sticky-start-header">
                  <mat-checkbox
                    (change)="$event ? toggleAllRows() : null"
                    [checked]="isAllSelected()"
                    [indeterminate]="isPartiallySelected()"
                    aria-label="Select all rows"
                  >
                  </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="sticky-start-cell">
                  <mat-checkbox
                    (click)="$event.stopPropagation()"
                    (change)="$event ? selection.toggle(row) : null"
                    [checked]="selection.isSelected(row)"
                    [aria-label]="checkboxLabel(row)"
                  >
                  </mat-checkbox>
                </td>
              </ng-container>

              <!-- Expand Column -->
              <ng-container matColumnDef="expand">
                <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
                <td mat-cell *matCellDef="let element">
                  @if(isTestbed(element)) {
                    <button mat-icon-button aria-label="expand row"
                      (click)="toggleRow(element); $event.stopPropagation()">
                      <mat-icon class="expand-icon" [class.expanded]="expandedElement() === element">chevron_right</mat-icon>
                    </button>
                  }
                </td>
              </ng-container>

              <!-- ID Column -->
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let element" class="limit-width">
                  <a
                    [routerLink]="['/devices', element.id]"
                    class="id-link truncate-text"
                    title="{{element.id}}"
                    matTooltip="{{element.id}}"
                    matTooltipPositionAtOrigin="true">
                    {{element.id}}
                    </a>
                </td>
              </ng-container>

              <!-- Health Column -->
              <ng-container matColumnDef="health">
                <th mat-header-cell *matHeaderCellDef>HEALTH</th>
                <td mat-cell *matCellDef="let element">
                  @let healthSemantic = getHealthSemantic(element.healthState.health);
                  <div class="health-wrapper">
                    <mat-icon
                      class="{{healthSemantic.colorClass}} health-icon"
                      matTooltip="{{element.healthState.title}}">
                      {{healthSemantic.icon}}
                    </mat-icon>
                    <mat-icon class="cursor-help" matTooltip="{{element.healthState.tooltip}}">help_outline</mat-icon>
                  </div>
                </td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>TYPE</th>
                <td mat-cell *matCellDef="let element">
                  @if(element.types.length > 0) {
                    <div class="type-chip-wrapper">
                      <div
                        class="type-chip"
                        [class.type-chip-abnormal]="isTypeAbnormal(element.types)"
                        [class.type-chip-normal]="!isTypeAbnormal(element.types)"
                      >
                        {{getFirstType(element.types)}}
                      </div>
                      @if(element.types.length > 1) {
                        <button
                          class="type-chip-more"
                          cdkOverlayOrigin
                          #trigger="cdkOverlayOrigin"
                          (mouseenter)="onTypeHover(trigger, element.id, element.types)"
                          (mouseleave)="handleMouseLeave($event)"
                        >
                          +{{ element.types.length - 1 }} more
                        </button>
                      }
                    </div>
                  } @else {
                    —
                  }
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>STATUS</th>
                <td mat-cell *matCellDef="let element">
                  <div
                    class="type-chip"
                    [class.type-chip-abnormal]="element.deviceStatus.isCritical"
                    [class.type-chip-normal]="!element.deviceStatus.isCritical"
                  >
                    {{element.deviceStatus.status}}
                  </div>
                </td>
              </ng-container>

              <!-- Label Column -->
              <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef>LABEL</th>
                <td mat-cell *matCellDef="let element" class="limit-width">
                  <span
                    class="truncate-text"
                    title="{{element.label}}"
                    matTooltip="{{element.label}}"
                    matTooltipPositionAtOrigin="true"
                  >{{element.label || '—'}}</span>
                </td>
              </ng-container>

              <!-- Required Dims Column -->
              <ng-container matColumnDef="requiredDims">
                <th mat-header-cell *matHeaderCellDef>REQUIRED DIMS</th>
                <td mat-cell *matCellDef="let element" class="limit-width">
                  <span
                    class="truncate-text"
                    title="{{element.requiredDims}}"
                    matTooltip="{{element.requiredDims}}"
                    matTooltipPositionAtOrigin="true"
                  >{{element.requiredDims || '—'}}</span>
                </td>
              </ng-container>

              <!-- Model Column -->
              <ng-container matColumnDef="model">
                <th mat-header-cell *matHeaderCellDef>MODEL</th>
                <td mat-cell *matCellDef="let element" class="limit-width">
                  <span
                    class="truncate-text"
                    title="{{element.model}}"
                    matTooltip="{{element.model}}"
                    matTooltipPositionAtOrigin="true"
                  >{{element.model || '—'}}</span>
                </td>
              </ng-container>

              <!-- Version Column -->
              <ng-container matColumnDef="version">
                <th mat-header-cell *matHeaderCellDef>VERSION</th>
                <td mat-cell *matCellDef="let element" class="limit-width">
                  <span
                    class="truncate-text"
                    title="{{element.version}}"
                    matTooltip="{{element.version}}"
                    matTooltipPositionAtOrigin="true"
                  >{{element.version || '—'}}</span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions" stickyEnd>
                <th mat-header-cell *matHeaderCellDef class="sticky-end-header">
                  <button mat-icon-button>
                    <mat-icon class="material-symbols-outlined">settings</mat-icon>
                  </button>
                </th>
                <td mat-cell *matCellDef="let element" class="sticky-end-cell">
                  <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Device actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item>
                      <mat-icon>screenshot</mat-icon>
                      <span>Screenshot</span>
                    </button>
                    <button mat-menu-item>
                      <mat-icon>important_devices</mat-icon>
                      <span>Remote Control</span>
                    </button>
                      <button mat-menu-item>
                      <mat-icon>flash_on</mat-icon>
                      <span>Flash</span>
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
                  <div class="element-detail"
                       [class.expanded]="element === expandedElement()">
                       @if(element.subDevices) {
                         <div class="sub-device-wrapper">
                           <table mat-table [dataSource]="element.subDevices" class="sub-device-table">
                             <!-- Sub-Device ID Column -->
                             <ng-container matColumnDef="id">
                               <th mat-header-cell *matHeaderCellDef> SUB-DEVICE ID </th>
                               <td mat-cell *matCellDef="let sub" class="sub-device-id"> {{sub.id}} </td>
                             </ng-container>

                             <!-- Model Column -->
                             <ng-container matColumnDef="model">
                               <th mat-header-cell *matHeaderCellDef> MODEL </th>
                               <td mat-cell *matCellDef="let sub"> {{sub.model || '-'}} </td>
                             </ng-container>

                             <!-- Version Column -->
                             <ng-container matColumnDef="version">
                               <th mat-header-cell *matHeaderCellDef> VERSION </th>
                               <td mat-cell *matCellDef="let sub"> {{sub.version || '-'}} </td>
                             </ng-container>

                             <!-- Type Column -->
                             <ng-container matColumnDef="type">
                               <th mat-header-cell *matHeaderCellDef> TYPE </th>
                               <td mat-cell *matCellDef="let sub">
                                 <app-overflow-list
                                   [items]="sub.types"
                                   [limit]="1"
                                   [itemTemplate]="typeTemplate"
                                   moreButtonClass="type-chip-more"
                                   (showOverlay)="onTypeHover($event, sub.id, sub.types)"
                                   (hideOverlay)="handleMouseLeave($event)">
                                 </app-overflow-list>
                                 <ng-template #typeTemplate let-type>
                                   <div
                                     class="type-chip"
                                     [class.type-chip-abnormal]="isTypeAbnormal([type])"
                                     [class.type-chip-normal]="!isTypeAbnormal([type])"
                                   >
                                     {{type.type}}
                                   </div>
                                 </ng-template>
                               </td>
                             </ng-container>

                             <!-- Battery Column -->
                             <ng-container matColumnDef="battery">
                               <th mat-header-cell *matHeaderCellDef> BATTERY </th>
                               <td mat-cell *matCellDef="let sub">
                                 {{ sub.batteryLevel !== null && sub.batteryLevel !== undefined ? sub.batteryLevel + '%' : '-' }}
                               </td>
                             </ng-container>

                             <!-- Wifi Column -->
                             <ng-container matColumnDef="wifi">
                               <th mat-header-cell *matHeaderCellDef> WIFI </th>
                               <td mat-cell *matCellDef="let sub">
                                 <div class="network-status">
                                   @if (sub.network?.wifiRssi !== undefined) {
                                     @let wifiIcon = getWifiSignalIcon(sub.network?.wifiRssi);
                                     @let wifiQuality = getWifiQualityText(sub.network?.wifiRssi);
                                     <mat-icon
                                       class="wifi-icon"
                                       title="Signal: {{ wifiQuality }} ({{ sub.network?.wifiRssi }} dBm)"
                                     >
                                       {{ wifiIcon }}
                                     </mat-icon>
                                   }
                                   @if (sub.network?.hasInternet === true) {
                                     <mat-icon class="internet-icon text-green-600" title="Internet access">public</mat-icon>
                                   } @else if (sub.network?.hasInternet === false) {
                                     <mat-icon class="internet-icon text-red-600" title="No internet access">public_off</mat-icon>
                                   } @else {
                                     <mat-icon class="wifi-icon" title="Unknown">signal_wifi_off</mat-icon>
                                     <span class="text-gray-600">Unknown</span>
                                   }
                                 </div>
                               </td>
                             </ng-container>

                             <!-- Actions Column -->
                             <ng-container matColumnDef="actions">
                               <th mat-header-cell *matHeaderCellDef> ACTION </th>
                               <td mat-cell *matCellDef="let sub">
                                 <div [matTooltip]="sub.remoteControl?.isSupported ? 'Remote Control' : (sub.remoteControl?.unsupportedReason || 'Not supported')"
                                      class="inline-block">
                                   <button mat-icon-button
                                           (click)="startSubDeviceRemoteControl(sub)"
                                           [disabled]="!sub.remoteControl?.isSupported">
                                     <mat-icon>important_devices</mat-icon>
                                   </button>
                                 </div>
                               </td>
                             </ng-container>

                             <tr mat-header-row *matHeaderRowDef="subDeviceDisplayedColumns"></tr>
                             <tr mat-row *matRowDef="let row; columns: subDeviceDisplayedColumns;"></tr>
                           </table>
                         </div>
                       }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="sticky-header"></tr>
              <tr mat-row *matRowDef="let element; columns: displayedColumns;"
                  class="element-row"
                  [class.expanded-row]="expandedElement() === element"
                  (click)="isTestbed(element) ? toggleRow(element) : null">
              </tr>
              <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

              <!-- Row shown when there is no matching data. -->
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data matching the filter.</td>
              </tr>
            </table>
          </div>
      </div>
    } @else {
      <div class="info-card-content">
        <p class="no-devices-text">No devices are connected to this host.</p>
      </div>
    }
  </app-info-card>
  <app-info-card #overviewSection id="daemon-server" title="Daemon Server" [collapsible]="false">
    <div operations class="operation-button">
      <a href="#" target="_blank">
        <mat-icon>article</mat-icon>
        <span class="operation-text">View Log</span>
        <mat-icon>open_in_new</mat-icon>
      </a>
    </div>
    <div class="info-card-content">
      <dl class="grid-tight">
        <dt>State</dt>
        @let daemonSemantic = getStatusSemantic(host.daemonServer.status);
        <dd
          class="grid-tight-dd {{ daemonSemantic.colorClass }}"
          title="{{ daemonSemantic.tooltip }}"
        >
          <mat-icon matTooltip="{{ daemonSemantic.tooltip }}">
            {{ daemonSemantic.icon }}
          </mat-icon>
          <span matTooltip="{{ daemonSemantic.tooltip }}">
            {{ daemonSemantic.text }}
            {{ daemonSemantic.duration ? '(' + daemonSemantic.duration + ')' : '' }}
          </span>
          <mat-icon matTooltip="{{ daemonSemantic.tooltip }}" class="cursor-help">
            help_outline
          </mat-icon>
        </dd>
        <dt>Version</dt>
        <dd>{{ host.daemonServer.version }}</dd>
      </dl>
    </div>
  </app-info-card>
  <app-info-card #overviewSection id="host-properties" title="Host Properties">
    <div id="properties-content" class="info-card-content">
      @if (host.properties && objectUtils.objectKeys(host.properties).length > 0) {
        <div class="data-block">
          <dl class="data-block-grid">
            @for (key of objectUtils.objectKeys(host.properties); track key) {
              <div class="data-block-row contents">
                <dt>{{ key }}</dt>
                <dd>{{ host.properties[key] }}</dd>
              </div>
            }
          </dl>
        </div>
      } @else {
        <p class="none-specified">None specified.</p>
      }
    </div>
  </app-info-card>
</app-master-detail-layout>

@if (activeOverlay(); as overlay) {
  <ng-template cdkConnectedOverlay
               [cdkConnectedOverlayOrigin]="overlay.origin"
               [cdkConnectedOverlayOpen]="true"
               [cdkConnectedOverlayPositions]="overlayPositions"
               (overlayOutsideClick)="closeOverlay()"
               (detach)="closeOverlay()">
    <div (mouseenter)="onOverlayEnter()" (mouseleave)="handleMouseLeave($event)">
      <app-searchable-list-overlay [data]="overlay.data" (closeOverlay)="closeOverlay()"></app-searchable-list-overlay>
    </div>
  </ng-template>
}





