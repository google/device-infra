<div class="header-actions">
  <!-- 2xl view -->
  <div class="header-actions-2xl">
    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'configuration',
      icon: 'settings',
      label: 'Configuration',
      handler: onConfiguration,
      mode: 'button',
      suffix: '2xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'screenshot',
      icon: 'screenshot',
      label: 'Screenshot',
      handler: onScreenshot,
      mode: 'button',
      loading: takingScreenshot(),
      loadingLabel: 'Taking...',
      suffix: '2xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'remoteControl',
      icon: 'important_devices',
      label: 'Remote Control',
      handler: onRemoteControl,
      mode: 'button',
      suffix: '2xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'flash',
      icon: 'flash_on',
      label: 'Flash',
      handler: onFlash,
      mode: 'button',
      suffix: '2xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'logcat',
      icon: 'description',
      label: 'Get Logcat',
      handler: onLogcat,
      mode: 'button',
      loading: gettingLogcat(),
      loadingLabel: 'Fetching...',
      suffix: '2xl'
    }"></ng-container>

    @if (actions?.quarantine?.visible) {
      @if (quarantineInfo?.isQuarantined) {
        <div class="m3-split-button-group" data-testid="quarantine-group-2xl">
          <button class="m3-split-button main-action" (click)="onQuarantine()" [disabled]="!actions?.quarantine?.enabled || unquarantining()" [matTooltip]="actions?.quarantine?.tooltip || ''">
            @if (unquarantining()) {
              <mat-icon class="spin-animation">sync</mat-icon>Working...
            } @else {
              <mat-icon>play_circle_outline</mat-icon>Unquarantine
            }
          </button>
          <button class="m3-split-button dropdown-action" [matMenuTriggerFor]="quarantineMenu2xl" matTooltip="Quarantine options" [disabled]="!actions?.quarantine?.enabled || unquarantining()">
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
          <mat-menu #quarantineMenu2xl="matMenu">
            <ng-container *ngTemplateOutlet="actionItem; context: {
              key: 'quarantine',
              icon: 'edit_calendar',
              label: 'Change Duration',
              handler: onChangeQuarantine,
              mode: 'menu',
              suffix: '2xl'
            }"></ng-container>
          </mat-menu>
        </div>
      } @else {
        <ng-container *ngTemplateOutlet="actionItem; context: {
          key: 'quarantine',
          icon: 'block',
          label: 'Quarantine',
          handler: onQuarantine,
          mode: 'button',
          suffix: '2xl'
        }"></ng-container>
      }
    }
  </div>

  <!-- xl view -->
  <div class="header-actions-xl">
    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'configuration',
      icon: 'settings',
      label: 'Configuration',
      handler: onConfiguration,
      mode: 'button',
      suffix: 'xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'screenshot',
      icon: 'screenshot',
      label: 'Screenshot',
      handler: onScreenshot,
      mode: 'button',
      loading: takingScreenshot(),
      loadingLabel: 'Taking...',
      suffix: 'xl'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'remoteControl',
      icon: 'important_devices',
      label: 'Remote Control',
      handler: onRemoteControl,
      mode: 'button',
      suffix: 'xl'
    }"></ng-container>

    <button
      class="m3-action-button transparent dropdown-trigger"
      [matMenuTriggerFor]="moreMenu"
      matTooltip="Show more actions"
    >
      <span>More</span>
      <mat-icon>expand_more</mat-icon>
    </button>
    <mat-menu #moreMenu="matMenu">
      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'flash',
        icon: 'flash_on',
        label: 'Flash',
        handler: onFlash,
        mode: 'menu',
        suffix: 'xl'
      }"></ng-container>

      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'logcat',
        icon: 'description',
        label: 'Get Logcat',
        handler: onLogcat,
        mode: 'menu',
        loading: gettingLogcat(),
        loadingLabel: 'Fetching...',
        suffix: 'xl'
      }"></ng-container>

      @if (actions?.quarantine?.visible) {
        @if (quarantineInfo?.isQuarantined) {
          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'play_circle_outline',
            label: 'Unquarantine',
            handler: onQuarantine,
            mode: 'menu',
            loading: unquarantining(),
            loadingLabel: 'Working...',
            suffix: 'xl'
          }"></ng-container>

          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'edit_calendar',
            label: 'Change Duration',
            handler: onChangeQuarantine,
            mode: 'menu',
            suffix: 'xl'
          }"></ng-container>
        } @else {
          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'block',
            label: 'Quarantine',
            handler: onQuarantine,
            mode: 'menu',
            suffix: 'xl'
          }"></ng-container>
        }
      }
    </mat-menu>
  </div>

  <!-- small view -->
  <div class="header-actions-sm">
    <ng-container *ngTemplateOutlet="actionItem; context: {
      key: 'configuration',
      icon: 'settings',
      label: 'Configuration',
      handler: onConfiguration,
      mode: 'button',
      suffix: 'sm'
    }"></ng-container>

    <button
      class="m3-action-button transparent dropdown-trigger"
      [matMenuTriggerFor]="actionsMenu"
      matTooltip="Show more actions"
    >
      <span>Take Action</span>
      <mat-icon>expand_more</mat-icon>
    </button>
    <mat-menu #actionsMenu="matMenu">
      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'screenshot',
        icon: 'screenshot',
        label: 'Screenshot',
        handler: onScreenshot,
        mode: 'menu',
        loading: takingScreenshot(),
        loadingLabel: 'Taking...',
        suffix: 'sm'
      }"></ng-container>

      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'remoteControl',
        icon: 'important_devices',
        label: 'Remote Control',
        handler: onRemoteControl,
        mode: 'menu',
        suffix: 'sm'
      }"></ng-container>

      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'flash',
        icon: 'flash_on',
        label: 'Flash',
        handler: onFlash,
        mode: 'menu',
        suffix: 'sm'
      }"></ng-container>

      <ng-container *ngTemplateOutlet="actionItem; context: {
        key: 'logcat',
        icon: 'description',
        label: 'Get Logcat',
        handler: onLogcat,
        mode: 'menu',
        loading: gettingLogcat(),
        loadingLabel: 'Fetching...',
        suffix: 'sm'
      }"></ng-container>

      @if (actions?.quarantine?.visible) {
        @if (quarantineInfo?.isQuarantined) {
          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'play_circle_outline',
            label: 'Unquarantine',
            handler: onQuarantine,
            mode: 'menu',
            loading: unquarantining(),
            loadingLabel: 'Working...',
            suffix: 'sm'
          }"></ng-container>

          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'edit_calendar',
            label: 'Change Duration',
            handler: onChangeQuarantine,
            mode: 'menu',
            suffix: 'sm'
          }"></ng-container>
        } @else {
          <ng-container *ngTemplateOutlet="actionItem; context: {
            key: 'quarantine',
            icon: 'block',
            label: 'Quarantine',
            handler: onQuarantine,
            mode: 'menu',
            suffix: 'sm'
          }"></ng-container>
        }
      }
    </mat-menu>
  </div>
</div>

<ng-template #actionItem
  let-key="key"
  let-icon="icon"
  let-label="label"
  let-handler="handler"
  let-mode="mode"
  let-loading="loading"
  let-loadingLabel="loadingLabel"
  let-suffix="suffix"
>
  @let action = getAction(key);
  @if (action?.visible) {
    @if (mode === 'button') {
      <button
        class="m3-action-button filled"
        (click)="handler()"
        [disabled]="!action?.enabled || (loading ?? false)"
        [matTooltip]="action?.tooltip || ''"
        [attr.data-testid]="key + '-button-' + suffix"
      >
        @if (loading) {
          <mat-icon class="spin-animation">sync</mat-icon>{{loadingLabel}}
        } @else {
          <mat-icon>{{icon}}</mat-icon>{{label}}
        }
      </button>
    } @else {
      <button
        mat-menu-item
        (click)="handler()"
        [disabled]="!action?.enabled || (loading ?? false)"
        [matTooltip]="action?.tooltip || ''"
        [attr.data-testid]="key + '-menu-item-' + suffix"
      >
        @if (loading) {
           <span>
             <mat-icon class="spin-animation dropdown-mat-icon">sync</mat-icon>
             <span>{{loadingLabel}}</span>
           </span>
        } @else {
          <ng-container>
            <mat-icon class="dropdown-mat-icon">{{icon}}</mat-icon>
            <span>{{label}}</span>
          </ng-container>
        }
      </button>
    }
  }
</ng-template>
