/*
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

edition = "2023";

package mobileharness.api.deviceconfig;

import "src/devtools/mobileharness/api/deviceconfig/proto/device.proto";
import "src/devtools/mobileharness/api/deviceconfig/proto/project.proto";

option java_package = "com.google.devtools.mobileharness.api.deviceconfig.proto";
option java_outer_classname = "LabProjectConfigProto";

// DeviceConfigs associated by HardwareFingerprint to represent the equivalent
// to the DeviceConfigService.GetTenantConfig RPC, but available locally.
message TenantDeviceConfigList {
  // The list of device configs
  repeated TenantDeviceConfig tenant_device_config = 1;
}

// A single mapping between hardware fingerprint and device config.
message TenantDeviceConfig {
  // The device pool for this config. A pool is a subdivision of devices in the
  // tenant, for example, a lab may have separate "presubmit" and "postsubmit"
  // device pools. An empty pool represents a "wildcard" config which devices in
  // any pool may match.
  string pool = 3;
  // A device selector for the given device config.
  HardwareFingerprint hardware_fingerprint = 1;
  // The device config to apply to a matching device.
  DeviceConfig device_config = 2;

  // Merge semantics for dimensions with name collisions in the tenant and
  // device config.
  //
  // Repeated conflicting dimensions in the  overridee are dropped, and in the
  // overrider are retained. For example:
  // overriding
  //   { ... { name: "label", value: "a" }, { name: "label", value: "b" } }
  // with
  //   { ... { name: "label", value: "c" } }
  // results in
  //   { ... { name: "label", value: "c" } }
  // and overriding
  //   { ... { name: "label", value: "a" } }
  // with
  //   { ... { name: "label", value: "c" }, { name: "label", value: "d" } }
  // results in
  //   { ... { name: "label", value: "c" }, { name: "label", value: "d" } }
  enum CompositeDimensionMergeSemantics {
    // Unspecified, will default to UNION.
    MERGE_SEMANTICS_UNSPECIFIED = 0;
    // Tenant config will override the device config. For exammple:
    //   tenant config: { ... { name: "label", value: "tenant" } }
    //   device config: { ... { name: "label", value: "device" } }
    //   merged config: { ... { name: "label", value: "tenant" } }
    MERGE_SEMANTICS_TENANT_OVERRIDES = 1;
    // Both are kept
    //   tenant config: { ... { name: "label", value: "tenant" } }
    //   device config: { ... { name: "label", value: "device" } }
    //   merged config: { ...
    //     { name: "label", value: "tenant" },
    //     { name:  "label", value: "device" }
    //   }
    MERGE_SEMANTICS_UNION = 2;
    // Device config will override the tenant config. For example:
    //   tenant config: { ... { name: "label", value: "tenant" } }
    //   device config: { ... { name: "label", value: "device" } }
    //   merged config: { ... { name: "label", value: "device" } }
    MERGE_SEMANTICS_DEVICE_OVERRIDES = 3;

    // TODO: add merge semantics for host config.
  }

  // TODO: Implement this.
  CompositeDimensionMergeSemantics merge_semantics = 4;
}
