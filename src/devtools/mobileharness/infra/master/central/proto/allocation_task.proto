/*
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

edition = "2023";

package mobileharness.infra.master.central;

import "src/devtools/mobileharness/api/model/proto/device.proto";

option java_package = "com.google.devtools.mobileharness.infra.master.central.proto";
option java_outer_classname = "AllocationTaskProto";

// A generic task to trigger the allocation workflow orchestrator for a given
// test. The orchestrator will load the test's full state from the
// database using the test_id/job_id and determine the next action to take based
// on its current state.
message AllocationTask {}

// ====================================================
// == FIELDS FOR ASYNCHRONOUS WORKFLOW ORCHESTRATION ==
// ====================================================

// Defines the type of allocation workflow to use for the test.
enum AllocationType {
  ALLOCATION_TYPE_UNSPECIFIED = 0;

  // The traditional, Omnilab Scheduler-only allocation workflow.
  TRADITIONAL = 1;

  // A test that requires allocation from both Scheduke and the Omnilab
  // Scheduler.
  HYBRID_CHROME_OS = 2;
}

// Defines the execution mode for tests that require multiple allocations.
enum AllocationParallelismMode {
  ALLOCATION_PARALLELISM_MODE_UNSPECIFIED = 0;

  // Allocations are performed sequentially. For HYBRID_CHROME_OS, this means
  // allocating from Scheduke first, and only after success, allocating from
  // the Omnilab Scheduler.
  SERIAL = 1;

  // Allocations are performed in parallel. For HYBRID_CHROME_OS, requests are
  // sent to both Scheduke and the Omnilab Scheduler concurrently. The workflow
  // proceeds only after both have succeeded.
  PARALLEL = 2;
}

// Tracks the granular state of the allocation workflow.
enum AllocationWorkflowStatus {
  ALLOCATION_WORKFLOW_STATUS_UNSPECIFIED = 0;

  // The request has been accepted and is waiting for orchestration.
  NEW = 1;

  // Waiting for Omnilab allocation to be completed.
  PENDING_OMNILAB = 2;

  // All required device allocations have successfully completed.
  ALLOCATED = 3;

  // The allocation workflow failed at one of the steps.
  FAILED = 4;

  // Waiting for Scheduke allocation to be completed.
  // This status is only used in HYBRID_CHROME_OS allocation.
  PENDING_SCHEDUKE = 5;

  // Scheduke allocation succeeded, waiting for Omnilab allocation to start.
  // This status is only used in HYBRID_CHROME_OS allocation.
  READY_FOR_OMNILAB = 6;

  // The test is being released.
  RELEASING = 7;

  // The test has been released.
  RELEASED = 8;
}

// Contains all intermediate data generated during the allocation workflow.
message AllocationWorkflowContext {
  // Information related to the Omnilab Scheduler allocation step.
  message OmnilabContext {
    // The scheduler id returned by the Omnilab Scheduler after submitting an
    // allocation request.
    string scheduler_id = 1;

    // The client id generated by Master.
    string client_id = 2;

    // The final device information returned by the Omnilab Scheduler upon
    // successful allocation.
    repeated .mobileharness.api.model.DeviceLocator allocated_device_locator =
        3;
  }

  // Information related to the Scheduke allocation step.
  message SchedukeContext {
    // The request ID returned by Scheduke after submitting an allocation
    // request.
    string scheduke_id = 1;

    // The allocation id returned by Scheduke, which is used for deallocation.
    string allocation_id = 2;

    // The final device information returned by Scheduke upon successful
    // allocation.
    repeated .mobileharness.api.model.DeviceLocator allocated_device_locator =
        3;

    // The network zone of the device leased from Scheduke.
    // This is used to ensure that the Omnilab executor is allocated in the same
    // network zone.
    string network_zone = 4;
  }

  OmnilabContext omnilab_context = 1;
  SchedukeContext scheduke_context = 2;
}

// Contains information about a failure in the allocation workflow.
message AllocationWorkflowFailure {
  // A detailed error message for debugging.
  string reason = 1;
}

// Defines the conditions for the allocation of a test.
message AllocationCondition {
  // Defines which workflow to execute for this test's allocation.
  AllocationType allocation_type = 1;

  // Tracks the detailed state of the multi-step allocation process.
  AllocationWorkflowStatus allocation_workflow_status = 2;

  // Stores all intermediate data from the allocation process, such as
  // request IDs and partial results.
  AllocationWorkflowContext allocation_workflow_context = 3;

  // If allocation_workflow_status is FAILED, this field should contain details
  // about the failure.
  AllocationWorkflowFailure allocation_workflow_failure = 4;

  // Defines the execution mode (ALLOCATION_PARALLELISM_MODE_SERIAL or
  // ALLOCATION_PARALLELISM_MODE_PARALLEL) for tests that require multiple
  // device allocations.
  AllocationParallelismMode allocation_mode = 5;
}
